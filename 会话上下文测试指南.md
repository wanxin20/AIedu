# 学习助手会话上下文测试指南

## 功能说明

学习助手现在支持完整的会话上下文管理，这意味着：
- ✅ AI能记住同一会话中之前的对话内容
- ✅ 可以进行连续的多轮对话
- ✅ 切换到不同会话时，上下文会分别保存
- ✅ 会话ID会自动保存到本地存储

## 优化内容

### 1. API层优化 (`learningAssistantApi.ts`)
- ✅ 增强了会话ID的提取逻辑，支持多种可能的字段名
- ✅ 添加了详细的调试日志，方便追踪会话状态
- ✅ 增强了JSON清理逻辑，过滤工具调用信息

### 2. UI层优化 (`StudentLearningAssistant.tsx`)
- ✅ 添加了"上下文已连接"状态指示器
- ✅ 增强了会话切换和创建的日志输出
- ✅ 优化了Markdown渲染，标题间距更合理

## 测试步骤

### 测试1：新会话上下文测试
1. 打开学习助手页面
2. 点击"新会话"按钮
3. 发送第一条消息，例如："我今年读初二"
4. 等待AI回复
5. **观察**：输入框上方应该出现绿色的"上下文已连接"指示器
6. 发送第二条消息："请推荐一些适合我的数学学习资料"
7. **验证**：AI应该能记住你读初二，并推荐适合初二的资料

### 测试2：会话切换测试
1. 在当前会话中，打开浏览器控制台（F12）
2. 发送一条消息
3. **观察控制台日志**：
   ```
   📤 发送消息
      当前会话ID: [一串ID]
      会话状态: 继续现有会话
   ```
4. 点击"新会话"按钮
5. **观察控制台日志**：
   ```
   🆕 创建新会话
      已清空会话ID，下次发送消息时将创建新的Coze会话
   ```
6. 发送新消息
7. **验证**：这是一个全新的对话，AI不会记住之前会话的内容

### 测试3：历史会话加载测试
1. 在某个会话中进行几轮对话
2. 点击"新会话"切换到新对话
3. 从左侧会话列表中点击之前的会话
4. **观察控制台日志**：
   ```
   📂 加载历史会话
      会话列表ID: session-xxx
      Coze会话ID: [会话ID]
      可以继续对话并保持上下文
   ```
5. 继续在这个会话中发送消息
6. **验证**：AI能记住这个会话之前的所有对话内容

## 控制台日志说明

### 发送消息时的日志
```javascript
📤 发送消息
   当前会话ID: 7xxx...  // Coze API的会话ID
   会话状态: 继续现有会话 或 将创建新会话
   当前会话列表ID: session-xxx  // 本地会话列表的ID
```

### 会话ID变更时的日志
```javascript
📌 会话ID变更: 无 -> 7xxx...
   变更原因: 新会话创建
```

或

```javascript
✅ 会话ID保持一致: 7xxx...
```

### API响应中的日志
```javascript
💬 获取到会话ID: 7xxx... 从事件: conversation.message.delta
✅ 会话ID已确认，后续对话将保持上下文
```

## 常见问题排查

### 问题1：上下文指示器没有显示
- **原因**：API没有返回会话ID
- **排查**：查看控制台是否有警告 `⚠️ 警告：未能从API响应中获取会话ID`
- **解决**：检查API配置和网络连接

### 问题2：AI记不住之前的对话
- **排查步骤**：
  1. 查看控制台，确认会话ID是否一致
  2. 确认每次发送消息时，日志显示"继续现有会话"
  3. 检查是否意外切换了会话或创建了新会话

### 问题3：切换会话后上下文混乱
- **原因**：旧会话没有保存会话ID（升级前创建的会话）
- **控制台提示**：`旧会话没有会话ID，继续对话将创建新的上下文`
- **解决**：对于旧会话，建议创建新会话重新开始对话

## 技术实现细节

### 会话ID的生命周期
1. **创建**：第一次发送消息时，Coze API自动创建并返回
2. **保存**：存储在React状态和localStorage中
3. **使用**：后续消息携带此ID，保持上下文
4. **切换**：加载不同会话时，会话ID随之切换
5. **清空**：点击"新会话"时清空，开始新的上下文

### 数据流
```
用户发送消息
  ↓
携带 currentConversationId 调用 chatWithAssistant()
  ↓
API返回响应 + conversationId
  ↓
更新 currentConversationId
  ↓
自动保存到 localStorage
  ↓
下次发送消息时继续使用此ID
```

## 开发者工具

### 查看会话ID
点击"上下文已连接"指示器旁边的ℹ️图标，可以复制当前会话ID

### 清除所有会话历史
在浏览器控制台执行：
```javascript
localStorage.removeItem('learningAssistantChatHistory');
localStorage.removeItem('coze_user_id');
```
然后刷新页面

## 参考文档
- [Coze API - 创建会话](https://www.coze.cn/open/docs/developer_guides/create_conversation)
- [Coze API - 会话隔离](https://www.coze.cn/open/docs/developer_guides/session_isolation)

