# åç«¯éƒ¨ç½²æŒ‡å— - æ™ºæ…§æ•™è¾…ç³»ç»Ÿ

## ğŸš€ è¶…ç®€å•éƒ¨ç½²æ­¥éª¤ï¼ˆ5æ­¥å®Œæˆï¼‰

### å‰ææ¡ä»¶
- å‰ç«¯å·²éƒ¨ç½²åœ¨ `/var/www/edu-platform`
- åŸŸåï¼šedu.gptpro.cn
- åç«¯ç«¯å£ï¼š5006

---

## ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ åç«¯æ–‡ä»¶

åœ¨æœ¬åœ°æ‰§è¡Œï¼š

```bash
# æ‰“åŒ…åç«¯æ–‡ä»¶ï¼ˆæ’é™¤ node_modulesï¼‰
cd /d/86135/Desktop/myprojects/AIedu
tar -czf backend.tar.gz backend --exclude=backend/node_modules

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp backend.tar.gz root@your-server-ip:/tmp/

# æˆ–ä½¿ç”¨ rsyncï¼ˆæ¨èï¼‰
rsync -avz --exclude='node_modules' backend/ root@your-server-ip:/var/www/aiedu-backend/
```

---

## ç¬¬äºŒæ­¥ï¼šæœåŠ¡å™¨ç«¯é…ç½®

SSH è¿æ¥åˆ°æœåŠ¡å™¨åæ‰§è¡Œï¼š

```bash
# 1. è§£å‹æ–‡ä»¶ï¼ˆå¦‚æœä½¿ç”¨ tarï¼‰
cd /var/www
tar -xzf /tmp/backend.tar.gz
mv backend aiedu-backend

# 2. è¿›å…¥åç«¯ç›®å½•
cd /var/www/aiedu-backend

# 3. å®‰è£…ä¾èµ–
npm install --production

# 4. ä¿®æ”¹ .env é…ç½®æ–‡ä»¶
nano .env
# æŒ‰å®é™…æƒ…å†µä¿®æ”¹æ•°æ®åº“å¯†ç ç­‰é…ç½®
# æŒ‰ Ctrl+O ä¿å­˜ï¼ŒCtrl+X é€€å‡º

# 5. æµ‹è¯•å¯åŠ¨ï¼ˆå¯é€‰ï¼ŒæŒ‰ Ctrl+C åœæ­¢ï¼‰
npm start
```

---

## ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ PM2 ç®¡ç†åç«¯æœåŠ¡

```bash
# 1. å®‰è£… PM2ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
npm install -g pm2

# 2. ä¿®æ”¹ ecosystem.config.js ä¸­çš„è·¯å¾„
nano ecosystem.config.js
# ç¡®è®¤ cwd è·¯å¾„ä¸º: /var/www/aiedu-backend

# 3. å¯åŠ¨åç«¯æœåŠ¡
pm2 start ecosystem.config.js

# 4. æŸ¥çœ‹çŠ¶æ€
pm2 status

# 5. æŸ¥çœ‹æ—¥å¿—
pm2 logs aiedu-backend

# 6. è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

---

## ç¬¬å››æ­¥ï¼šæ›´æ–° Nginx é…ç½®

```bash
# 1. å¤‡ä»½åŸé…ç½®
sudo cp /etc/nginx/sites-available/edu.gptpro.cn /etc/nginx/sites-available/edu.gptpro.cn.bak

# 2. ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/nginx/sites-available/edu.gptpro.cn

# åœ¨ server å—ä¸­æ·»åŠ ï¼ˆåœ¨ location / ä¹‹å‰ï¼‰ï¼š
```

```nginx
    # API ä»£ç†åˆ°åç«¯
    location /api {
        proxy_pass http://localhost:5006;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
```

```bash
# 3. æµ‹è¯•é…ç½®
sudo nginx -t

# 4. é‡å¯ Nginx
sudo systemctl restart nginx
```

---

## ç¬¬äº”æ­¥ï¼šéªŒè¯éƒ¨ç½²

```bash
# 1. æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
pm2 status
pm2 logs aiedu-backend --lines 50

# 2. æµ‹è¯•åç«¯ API
curl http://localhost:5006/api/health

# 3. æµ‹è¯•é€šè¿‡ Nginx ä»£ç†
curl http://edu.gptpro.cn/api/health

# 4. æŸ¥çœ‹ç«¯å£å ç”¨
sudo lsof -i :5006
```

å¦‚æœéƒ½è¿”å›æ­£å¸¸ï¼Œè¯´æ˜éƒ¨ç½²æˆåŠŸï¼ğŸ‰

---

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

### PM2 ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs aiedu-backend

# é‡å¯æœåŠ¡
pm2 restart aiedu-backend

# åœæ­¢æœåŠ¡
pm2 stop aiedu-backend

# åˆ é™¤æœåŠ¡
pm2 delete aiedu-backend

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 describe aiedu-backend

# ç›‘æ§
pm2 monit
```

### æ—¥å¿—æŸ¥çœ‹

```bash
# PM2 æ—¥å¿—
pm2 logs aiedu-backend --lines 100

# é”™è¯¯æ—¥å¿—
pm2 logs aiedu-backend --err

# Nginx æ—¥å¿—
sudo tail -f /var/log/nginx/edu-platform-error.log
sudo tail -f /var/log/nginx/edu-platform-access.log

# åº”ç”¨æ—¥å¿—
tail -f /var/www/aiedu-backend/logs/error.log
tail -f /var/www/aiedu-backend/logs/out.log
```

---

## ğŸ”„ æ—¥å¸¸æ›´æ–°æµç¨‹

å½“ä»£ç æœ‰æ›´æ–°æ—¶ï¼š

```bash
# 1. æœ¬åœ°æ‰“åŒ…
cd /d/86135/Desktop/myprojects/AIedu
tar -czf backend.tar.gz backend --exclude=backend/node_modules

# 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp backend.tar.gz root@your-server-ip:/tmp/

# 3. æœåŠ¡å™¨ç«¯æ›´æ–°
ssh root@your-server-ip
cd /var/www/aiedu-backend
tar -xzf /tmp/backend.tar.gz --strip-components=1
npm install --production
pm2 restart aiedu-backend
```

**æˆ–ä½¿ç”¨ rsyncï¼ˆæ¨èï¼Œæ›´å¿«ï¼‰ï¼š**

```bash
# æœ¬åœ°æ‰§è¡Œ
rsync -avz --exclude='node_modules' backend/ root@your-server-ip:/var/www/aiedu-backend/

# æœåŠ¡å™¨æ‰§è¡Œ
ssh root@your-server-ip "cd /var/www/aiedu-backend && npm install --production && pm2 restart aiedu-backend"
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: npm install å¤±è´¥ï¼Ÿ
```bash
# æ¸…ç†ç¼“å­˜åé‡è¯•
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### Q2: PM2 å¯åŠ¨å¤±è´¥ï¼Ÿ
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
pm2 logs aiedu-backend --err --lines 50

# æ£€æŸ¥ .env é…ç½®
cat .env

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
cd /var/www/aiedu-backend
npm start
```

### Q3: æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Ÿ
```bash
# æ£€æŸ¥æ•°æ®åº“æœåŠ¡
sudo systemctl status mysql

# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -h localhost -P 35819 -u root -p

# æ£€æŸ¥ .env ä¸­çš„æ•°æ®åº“é…ç½®
```

### Q4: API 502 é”™è¯¯ï¼Ÿ
```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
pm2 status

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
sudo lsof -i :5006

# é‡å¯åç«¯æœåŠ¡
pm2 restart aiedu-backend

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/edu-platform-error.log
```

### Q5: ç«¯å£è¢«å ç”¨ï¼Ÿ
```bash
# æŸ¥çœ‹å ç”¨è¿›ç¨‹
sudo lsof -i :5006

# æ€æ­»è¿›ç¨‹ï¼ˆå¦‚æœç¡®è®¤å¯ä»¥æ€ï¼‰
sudo kill -9 <PID>

# æˆ–ä¿®æ”¹ç«¯å£ï¼ˆåœ¨ .env å’Œ ecosystem.config.js ä¸­ï¼‰
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

1. **ä¿®æ”¹é»˜è®¤å¯†é’¥**
   ```bash
   nano /var/www/aiedu-backend/.env
   # ä¿®æ”¹ JWT_SECRET å’Œå…¶ä»–æ•æ„Ÿä¿¡æ¯
   ```

2. **è®¾ç½®æ–‡ä»¶æƒé™**
   ```bash
   chmod 600 /var/www/aiedu-backend/.env
   chmod 755 /var/www/aiedu-backend
   ```

3. **é…ç½®é˜²ç«å¢™**
   ```bash
   # åªå…è®¸ Nginx è®¿é—®åç«¯ç«¯å£ï¼ˆå¯é€‰ï¼‰
   sudo ufw allow from 127.0.0.1 to any port 5006
   ```

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### æ€§èƒ½ç›‘æ§
```bash
# å®æ—¶ç›‘æ§
pm2 monit

# å†…å­˜å’Œ CPU ä½¿ç”¨
pm2 list
```

### æ—¥å¿—è½®è½¬ï¼ˆé˜²æ­¢æ—¥å¿—è¿‡å¤§ï¼‰
```bash
# å®‰è£… PM2 æ—¥å¿—è½®è½¬æ¨¡å—
pm2 install pm2-logrotate

# é…ç½®è½®è½¬
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æä¾›ï¼š
1. PM2 æ—¥å¿—ï¼š`pm2 logs aiedu-backend --lines 100`
2. Nginx é”™è¯¯æ—¥å¿—ï¼š`sudo tail -100 /var/log/nginx/edu-platform-error.log`
3. ç³»ç»Ÿä¿¡æ¯ï¼š`uname -a`ã€`node -v`ã€`npm -v`

ç¥éƒ¨ç½²é¡ºåˆ©ï¼ğŸš€

