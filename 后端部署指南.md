# 后端部署指南 - 智慧教辅系统

## 🚀 超简单部署步骤（5步完成）

### 前提条件
- 前端已部署在 `/var/www/edu-platform`
- 域名：edu.gptpro.cn
- 后端端口：5006

---

## 第一步：上传后端文件

在本地执行：

```bash
# 打包后端文件（排除 node_modules）
cd /d/86135/Desktop/myprojects/AIedu
tar -czf backend.tar.gz backend --exclude=backend/node_modules

# 上传到服务器
scp backend.tar.gz root@your-server-ip:/tmp/

# 或使用 rsync（推荐）
rsync -avz --exclude='node_modules' backend/ root@your-server-ip:/var/www/aiedu-backend/
```

---

## 第二步：服务器端配置

SSH 连接到服务器后执行：

```bash
# 1. 解压文件（如果使用 tar）
cd /var/www
tar -xzf /tmp/backend.tar.gz
mv backend aiedu-backend

# 2. 进入后端目录
cd /var/www/aiedu-backend

# 3. 安装依赖
npm install --production

# 4. 修改 .env 配置文件
nano .env
# 按实际情况修改数据库密码等配置
# 按 Ctrl+O 保存，Ctrl+X 退出

# 5. 测试启动（可选，按 Ctrl+C 停止）
npm start
```

---

## 第三步：使用 PM2 管理后端服务

```bash
# 1. 安装 PM2（如果未安装）
npm install -g pm2

# 2. 修改 ecosystem.config.js 中的路径
nano ecosystem.config.js
# 确认 cwd 路径为: /var/www/aiedu-backend

# 3. 启动后端服务
pm2 start ecosystem.config.js

# 4. 查看状态
pm2 status

# 5. 查看日志
pm2 logs aiedu-backend

# 6. 设置开机自启
pm2 startup
pm2 save
```

---

## 第四步：更新 Nginx 配置

```bash
# 1. 备份原配置
sudo cp /etc/nginx/sites-available/edu.gptpro.cn /etc/nginx/sites-available/edu.gptpro.cn.bak

# 2. 编辑配置文件
sudo nano /etc/nginx/sites-available/edu.gptpro.cn

# 在 server 块中添加（在 location / 之前）：
```

```nginx
    # API 代理到后端
    location /api {
        proxy_pass http://localhost:5006;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
```

```bash
# 3. 测试配置
sudo nginx -t

# 4. 重启 Nginx
sudo systemctl restart nginx
```

---

## 第五步：验证部署

```bash
# 1. 检查后端服务状态
pm2 status
pm2 logs aiedu-backend --lines 50

# 2. 测试后端 API
curl http://localhost:5006/api/health

# 3. 测试通过 Nginx 代理
curl http://edu.gptpro.cn/api/health

# 4. 查看端口占用
sudo lsof -i :5006
```

如果都返回正常，说明部署成功！🎉

---

## 📋 常用命令速查

### PM2 管理命令

```bash
# 查看状态
pm2 status

# 查看日志
pm2 logs aiedu-backend

# 重启服务
pm2 restart aiedu-backend

# 停止服务
pm2 stop aiedu-backend

# 删除服务
pm2 delete aiedu-backend

# 查看详细信息
pm2 describe aiedu-backend

# 监控
pm2 monit
```

### 日志查看

```bash
# PM2 日志
pm2 logs aiedu-backend --lines 100

# 错误日志
pm2 logs aiedu-backend --err

# Nginx 日志
sudo tail -f /var/log/nginx/edu-platform-error.log
sudo tail -f /var/log/nginx/edu-platform-access.log

# 应用日志
tail -f /var/www/aiedu-backend/logs/error.log
tail -f /var/www/aiedu-backend/logs/out.log
```

---

## 🔄 日常更新流程

当代码有更新时：

```bash
# 1. 本地打包
cd /d/86135/Desktop/myprojects/AIedu
tar -czf backend.tar.gz backend --exclude=backend/node_modules

# 2. 上传到服务器
scp backend.tar.gz root@your-server-ip:/tmp/

# 3. 服务器端更新
ssh root@your-server-ip
cd /var/www/aiedu-backend
tar -xzf /tmp/backend.tar.gz --strip-components=1
npm install --production
pm2 restart aiedu-backend
```

**或使用 rsync（推荐，更快）：**

```bash
# 本地执行
rsync -avz --exclude='node_modules' backend/ root@your-server-ip:/var/www/aiedu-backend/

# 服务器执行
ssh root@your-server-ip "cd /var/www/aiedu-backend && npm install --production && pm2 restart aiedu-backend"
```

---

## ❓ 常见问题

### Q1: npm install 失败？
```bash
# 清理缓存后重试
npm cache clean --force
rm -rf node_modules package-lock.json
npm install
```

### Q2: PM2 启动失败？
```bash
# 查看详细错误
pm2 logs aiedu-backend --err --lines 50

# 检查 .env 配置
cat .env

# 手动启动测试
cd /var/www/aiedu-backend
npm start
```

### Q3: 数据库连接失败？
```bash
# 检查数据库服务
sudo systemctl status mysql

# 测试数据库连接
mysql -h localhost -P 35819 -u root -p

# 检查 .env 中的数据库配置
```

### Q4: API 502 错误？
```bash
# 检查后端服务是否运行
pm2 status

# 检查端口是否被占用
sudo lsof -i :5006

# 重启后端服务
pm2 restart aiedu-backend

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/edu-platform-error.log
```

### Q5: 端口被占用？
```bash
# 查看占用进程
sudo lsof -i :5006

# 杀死进程（如果确认可以杀）
sudo kill -9 <PID>

# 或修改端口（在 .env 和 ecosystem.config.js 中）
```

---

## 🔒 安全建议

1. **修改默认密钥**
   ```bash
   nano /var/www/aiedu-backend/.env
   # 修改 JWT_SECRET 和其他敏感信息
   ```

2. **设置文件权限**
   ```bash
   chmod 600 /var/www/aiedu-backend/.env
   chmod 755 /var/www/aiedu-backend
   ```

3. **配置防火墙**
   ```bash
   # 只允许 Nginx 访问后端端口（可选）
   sudo ufw allow from 127.0.0.1 to any port 5006
   ```

---

## 📊 监控和维护

### 性能监控
```bash
# 实时监控
pm2 monit

# 内存和 CPU 使用
pm2 list
```

### 日志轮转（防止日志过大）
```bash
# 安装 PM2 日志轮转模块
pm2 install pm2-logrotate

# 配置轮转
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
```

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. PM2 日志：`pm2 logs aiedu-backend --lines 100`
2. Nginx 错误日志：`sudo tail -100 /var/log/nginx/edu-platform-error.log`
3. 系统信息：`uname -a`、`node -v`、`npm -v`

祝部署顺利！🚀

